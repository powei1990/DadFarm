<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPIO_Control</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</head>
<style>
    table,
    th,
    td {
        border: 1px solid black;
    }
    
    .myAlert-bottom {
        position: fixed;
        bottom: 5px;
        left: 2%;
        width: 96%;
    }
    
    .alert {
        display: none;
    }
    
    .chart-container {
        position: relative;
        margin: auto;
        height: 80vh;
        width: 80vw;
    }
</style>

<body>
    <div class="btn-group m-3" role="group" aria-label="Basic radio toggle button group">
        <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off">
        <label class="btn btn-outline-primary" for="btnradio1">熱水器 開</label>

        <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">
        <label class="btn btn-outline-primary" for="btnradio2">熱水器 關</label>

    </div>

    <div class="m-3">
        <select class="form-select" id="timeset" aria-label="time set">
            <option value="0">00:00</option>
            <option value="1">01:00</option>
            <option value="2">02:00</option>
            <option value="3">03:00</option>
            <option value="4">04:00</option>
            <option value="5">05:00</option>
            <option value="6">06:00</option>
            <option value="7">07:00</option>
            <option value="8">08:00</option>
            <option value="9">09:00</option>
            <option value="10">10:00</option>
            <option value="11">11:00</option>
            <option value="12">12:00</option>
            <option value="13">13:00</option>
            <option value="14">14:00</option>
            <option value="15">15:00</option>
            <option value="16">16:00</option>
            <option value="17">17:00</option>
            <option value="18">18:00</option>
            <option value="19">19:00</option>
            <option value="20">20:00</option>
            <option value="21">21:00</option>
            <option value="22">22:00</option>
            <option value="23">23:00</option>
          </select>
    </div>

    <div class="myAlert-bottom alert alert-danger">
        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a> This alert box could indicate a dangerous or potentially negative action.
    </div>

    <div class="chart-container">
        <canvas id="myChart"></canvas>
    </div>

    <script>
        const socket = io.connect();

        socket.on("connect", () => {
            console.log(socket.id);
        });


        $('#btnradio1').on('click', function() {
            console.log("lightOn")
            socket.emit('ledon');
            myAlertBottom(11, "開啟");
        })
        $('#btnradio2').on('click', function() {
            console.log("lightOff")
            socket.emit('ledoff');
            myAlertBottom(11, "關閉");
        })

        $("#timeset").change(function() {
            alert("Handler for .change() called.");
            socket.emit('setTime', this.value);
        });

        function myAlertBottom(pingNum, isOn) {
            console.log(pingNum, isOn)
            $(".myAlert-bottom").text("第" + pingNum + "腳位，" + isOn)

            $(".myAlert-bottom").show();
            setTimeout(function() {
                $(".myAlert-bottom").hide();
            }, 2000);
        }

        //檢查狀態
        $(document).ready(function() {


            if (<%=isLedOn%> != 1) {
                $('#btnradio2').prop('checked', true);


            } else {
                $('#btnradio1').prop('checked', true);
            }
        });


        //要抓DB日期array，label換日期

        const labels = [
            <%
                docs.forEach( function(d) {
             %>
            <%= d['date'].getUTCHours()%>,
            <% }); %>

        ];


        //data換溫度
        const data = {
            labels: labels,
            datasets: [{
                label: '室內溫度',
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: [
                    <%docs.forEach( function(d) { %>
                    <%= d['temperature_c']%>,
                    <% }); %>
                ]
            }]
        };
        const config = {
            type: 'line',
            data,
            options: {}
        };



        var myChart = new Chart(
            document.getElementById('myChart'),
            config
        );
    </script>

</body>

</html>